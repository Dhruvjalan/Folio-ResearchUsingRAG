<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Folio — Research Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=DM+Mono:wght@400;500&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0e0e0f;
      --surface: #161618;
      --surface-2: #1e1e21;
      --border: #2a2a2e;
      --border-light: #3a3a3f;
      --text: #e8e6e0;
      --text-dim: #8a877f;
      --text-muted: #5a5855;
      --accent: #c9a96e;
      --accent-dim: rgba(201, 169, 110, 0.12);
      --accent-glow: rgba(201, 169, 110, 0.06);
      --red: #c96e6e;
      --green: #6ec96e;
      --mono: 'DM Mono', monospace;
      --serif: 'Libre Baskerville', Georgia, serif;
      --sans: 'Instrument Sans', sans-serif;
    }

    html { height: 100%; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── TOPBAR ── */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 28px;
      height: 52px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 26px;
      height: 26px;
      border: 1.5px solid var(--accent);
      border-radius: 4px;
      display: grid;
      place-items: center;
      position: relative;
    }
    .logo-mark::before {
      content: '';
      width: 10px;
      height: 12px;
      background: var(--accent);
      clip-path: polygon(0 0, 65% 0, 100% 30%, 100% 100%, 0 100%);
    }

    .logo-text {
      font-family: var(--serif);
      font-size: 17px;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    .logo-text span {
      color: var(--accent);
    }

    .topbar-meta {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.06em;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .status-dot {
      display: flex;
      align-items: center;
      gap: 7px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    .status-dot::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: background 0.3s;
    }

    .status-dot.online::before { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.error::before { background: var(--red); }

    /* ── MAIN LAYOUT ── */
    .main {
      display: grid;
      grid-template-columns: 300px 1fr;
      height: calc(100vh - 52px);
      overflow: hidden;
    }

    /* ── LEFT PANEL ── */
    .panel-left {
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--surface);
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-title {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .paper-count {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--accent);
      background: var(--accent-dim);
      padding: 2px 8px;
      border-radius: 20px;
    }

    /* ── UPLOAD ZONE ── */
    .upload-zone {
      margin: 16px;
      border: 1.5px dashed var(--border-light);
      border-radius: 8px;
      padding: 20px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      flex-shrink: 0;
    }

    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    .upload-zone input[type=file] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-icon {
      width: 36px;
      height: 36px;
      margin: 0 auto 10px;
      opacity: 0.4;
    }

    .upload-zone:hover .upload-icon { opacity: 0.8; }

    .upload-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }

    .upload-sub {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-muted);
    }

    /* ── PAPER LIST ── */
    .paper-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px 12px;
    }

    .paper-list::-webkit-scrollbar { width: 4px; }
    .paper-list::-webkit-scrollbar-track { background: transparent; }
    .paper-list::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 2px; }

    .paper-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
      border: 1px solid transparent;
      margin-bottom: 4px;
      animation: fadeSlideIn 0.3s ease both;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .paper-item:hover { background: var(--surface-2); border-color: var(--border); }
    .paper-item.active { background: var(--accent-dim); border-color: rgba(201,169,110,0.2); }

    .paper-icon {
      flex-shrink: 0;
      width: 30px;
      height: 38px;
      background: var(--surface-2);
      border-radius: 3px;
      border: 1px solid var(--border-light);
      display: grid;
      place-items: center;
      font-family: var(--mono);
      font-size: 8px;
      color: var(--accent);
      letter-spacing: 0.04em;
      font-weight: 500;
    }

    .paper-item.active .paper-icon {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .paper-info { flex: 1; min-width: 0; }

    .paper-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4;
    }

    .paper-meta {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .paper-remove {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      padding: 2px;
      border-radius: 3px;
      flex-shrink: 0;
      opacity: 0;
      transition: opacity 0.15s, color 0.15s;
      font-size: 14px;
      line-height: 1;
    }

    .paper-item:hover .paper-remove { opacity: 1; }
    .paper-remove:hover { color: var(--red); }

    /* ── SOURCE SELECTOR ── */
    .source-toggle {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .source-label {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .toggle-group {
      display: flex;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 3px;
      gap: 2px;
    }

    .toggle-btn {
      flex: 1;
      padding: 6px 10px;
      background: transparent;
      border: none;
      border-radius: 4px;
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }

    .toggle-btn.active {
      background: var(--surface-2);
      color: var(--accent);
      border: 1px solid var(--border-light);
    }

    /* ── RIGHT PANEL ── */
    .panel-right {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── CHAT AREA ── */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      scroll-behavior: smooth;
    }

    .chat-area::-webkit-scrollbar { width: 4px; }
    .chat-area::-webkit-scrollbar-track { background: transparent; }
    .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ── EMPTY STATE ── */
    .empty-state {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }

    .empty-glyph {
      font-family: var(--serif);
      font-size: 64px;
      color: var(--border-light);
      margin-bottom: 24px;
      line-height: 1;
      font-style: italic;
    }

    .empty-title {
      font-family: var(--serif);
      font-size: 22px;
      color: var(--text-dim);
      margin-bottom: 8px;
      font-style: italic;
    }

    .empty-sub {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 380px;
      line-height: 1.6;
    }

    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 28px;
      max-width: 500px;
    }

    .chip {
      padding: 8px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.15s;
      font-family: var(--sans);
    }

    .chip:hover {
      background: var(--surface-2);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ── MESSAGES ── */
    .messages {
      padding: 28px 36px;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .msg-group {
      animation: fadeSlideIn 0.35s ease both;
    }

    .msg-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 24px 0 20px;
      opacity: 0.5;
    }

    .msg-divider::before, .msg-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .msg-divider-text {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text-muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    /* User message */
    .msg-user {
      padding: 16px 20px 16px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }

    .msg-user-label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .msg-user-text {
      font-family: var(--serif);
      font-size: 16px;
      line-height: 1.65;
      color: var(--text);
      font-style: italic;
    }

    /* Assistant message */
    .msg-assistant {
      padding: 20px 0;
    }

    .msg-assistant-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .msg-assistant-icon {
      width: 22px;
      height: 22px;
      border-radius: 4px;
      background: var(--accent-dim);
      border: 1px solid rgba(201,169,110,0.25);
      display: grid;
      place-items: center;
      flex-shrink: 0;
    }

    .msg-assistant-icon svg {
      width: 12px;
      height: 12px;
      fill: var(--accent);
    }

    .msg-assistant-label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--accent);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .msg-assistant-body {
      font-size: 14px;
      line-height: 1.75;
      color: var(--text);
      padding-left: 32px;
    }

    .msg-assistant-body p { margin-bottom: 12px; }
    .msg-assistant-body p:last-child { margin-bottom: 0; }

    .msg-assistant-body code {
      font-family: var(--mono);
      font-size: 12px;
      background: var(--surface-2);
      padding: 2px 6px;
      border-radius: 3px;
      color: var(--accent);
    }

    .msg-assistant-body strong { color: var(--text); font-weight: 600; }

    /* Typing indicator */
    .typing-indicator {
      padding: 20px 0;
      display: none;
    }

    .typing-indicator.visible { display: block; }

    .typing-dots {
      display: flex;
      gap: 5px;
      padding-left: 32px;
    }

    .typing-dots span {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--text-muted);
      animation: typingPulse 1.2s ease-in-out infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingPulse {
      0%, 60%, 100% { transform: scale(1); opacity: 0.4; }
      30% { transform: scale(1.4); opacity: 1; }
    }

    /* ── INPUT AREA ── */
    .input-area {
      padding: 16px 28px 20px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .input-context-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .context-tag {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px 3px 8px;
      background: var(--accent-dim);
      border: 1px solid rgba(201,169,110,0.2);
      border-radius: 20px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--accent);
      animation: fadeSlideIn 0.2s ease both;
    }

    .context-tag-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--accent);
      flex-shrink: 0;
    }

    .context-none {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-muted);
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 12px 16px;
      font-family: var(--sans);
      font-size: 14px;
      color: var(--text);
      resize: none;
      min-height: 48px;
      max-height: 180px;
      line-height: 1.5;
      transition: border-color 0.2s;
      outline: none;
    }

    textarea:focus { border-color: var(--accent); }
    textarea::placeholder { color: var(--text-muted); }

    .send-btn {
      width: 48px;
      height: 48px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: grid;
      place-items: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }

    .send-btn:hover { background: #d4b47a; transform: translateY(-1px); }
    .send-btn:active { transform: translateY(0); }
    .send-btn:disabled { background: var(--border); cursor: not-allowed; transform: none; }

    .send-btn svg { width: 18px; height: 18px; fill: var(--bg); }

    .input-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }

    .input-hint {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-muted);
    }

    .char-count {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-muted);
    }

    /* ── UPLOAD PROGRESS ── */
    .upload-progress {
      margin: 0 12px 8px;
      display: none;
    }

    .upload-progress.visible { display: block; }

    .progress-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: var(--surface-2);
      border-radius: 5px;
      margin-bottom: 4px;
    }

    .progress-name {
      flex: 1;
      font-size: 11px;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .progress-bar-wrap {
      width: 60px;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s;
    }

    .progress-status {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    /* ── NOTIFICATION ── */
    .notification {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface-2);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 13px;
      color: var(--text);
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      transform: translateY(10px);
      opacity: 0;
      transition: all 0.25s;
      pointer-events: none;
      z-index: 1000;
      max-width: 300px;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .notification.error { border-color: var(--red); }
    .notification.success { border-color: var(--green); }

    /* Empty paper state */
    .no-papers {
      padding: 20px 20px 0;
      text-align: center;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.6;
    }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="logo">
      <div class="logo-mark"></div>
      <span class="logo-text">Folio<span>.</span></span>
    </div>
    <div class="topbar-meta">Research Intelligence System</div>
    <div class="topbar-right">
      <span class="status-dot" id="statusDot">checking...</span>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">

    <!-- LEFT PANEL -->
    <div class="panel-left">
      <div class="panel-header">
        <span class="panel-title">Papers</span>
        <span class="paper-count" id="paperCount">0</span>
      </div>

      <!-- Upload Zone -->
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".pdf" multiple />
        <svg class="upload-icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="4" width="18" height="24" rx="2" stroke="#c9a96e" stroke-width="1.5"/>
          <path d="M22 4v8h8" stroke="#c9a96e" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M29 16 22 4" stroke="#c9a96e" stroke-width="1.5"/>
          <circle cx="27" cy="30" r="8" fill="#0e0e0f" stroke="#c9a96e" stroke-width="1.5"/>
          <path d="M27 26v8M23 30l4-4 4 4" stroke="#c9a96e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="upload-title">Drop PDFs here</div>
        <div class="upload-sub">or click to browse</div>
      </div>

      <!-- Progress -->
      <div class="upload-progress" id="uploadProgress"></div>

      <!-- Paper List -->
      <div class="paper-list" id="paperList">
        <div class="no-papers" id="noPapers">No papers added yet.<br>Upload PDFs to begin analysis.</div>
      </div>

      <!-- Source Toggle -->
      <div class="source-toggle">
        <div class="source-label">Context Source</div>
        <div class="toggle-group">
          <button class="toggle-btn active" data-source="uploads" id="srcUploads">Uploaded PDFs</button>
          <button class="toggle-btn" data-source="s3" id="srcS3">S3 Bucket</button>
          <button class="toggle-btn" data-source="both" id="srcBoth">Both</button>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="panel-right">
      <div class="chat-area" id="chatArea">
        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
          <div class="empty-glyph">§</div>
          <div class="empty-title">Begin your inquiry</div>
          <div class="empty-sub">Upload research papers or connect to your S3 bucket, then ask anything about your documents.</div>
          <div class="suggestion-chips">
            <div class="chip" onclick="useChip(this)">Summarize the main findings</div>
            <div class="chip" onclick="useChip(this)">What methodology was used?</div>
            <div class="chip" onclick="useChip(this)">Compare key arguments</div>
            <div class="chip" onclick="useChip(this)">What are the limitations?</div>
            <div class="chip" onclick="useChip(this)">Extract citations</div>
          </div>
        </div>

        <!-- Messages Container -->
        <div class="messages" id="messages" style="display:none;"></div>
      </div>

      <!-- Input Area -->
      <div class="input-area">
        <div class="input-context-bar" id="contextBar">
          <span class="context-none" id="contextNone">No context loaded</span>
        </div>
        <div class="input-row">
          <div class="input-wrapper">
            <textarea
              id="questionInput"
              placeholder="Ask a question about your papers…"
              rows="1"
            ></textarea>
          </div>
          <button class="send-btn" id="sendBtn" onclick="sendQuestion()">
            <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 10L2 2l6 8-6 8L18 10z"/>
            </svg>
          </button>
        </div>
        <div class="input-footer">
          <span class="input-hint">⏎ send &nbsp;·&nbsp; Shift+⏎ newline</span>
          <span class="char-count" id="charCount">0</span>
        </div>
      </div>
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    // ─── STATE ───
    const API_BASE = "http://127.0.0.1:5000";
    let uploadedPapers = []; // { id, name, size, b64 }
    let activeSource = 'uploads';
    let isLoading = false;
    let msgCount = 0;

    // ─── INIT ───
    checkHealth();
    autoResizeTextarea();

    async function checkHealth() {
      const dot = document.getElementById('statusDot');
      try {
        const r = await fetch(`${API_BASE}/health`);
        if (r.ok) {
          const d = await r.json();
          dot.textContent = `online · ${d.source || 'ready'}`;
          dot.className = 'status-dot online';
        } else throw new Error();
      } catch {
        dot.textContent = 'offline';
        dot.className = 'status-dot error';
      }
    }

    // ─── UPLOAD ───
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
    uploadZone.addEventListener('drop', e => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    function handleFiles(files) {
      const pdfs = Array.from(files).filter(f => f.type === 'application/pdf' || f.name.endsWith('.pdf'));
      if (!pdfs.length) { showNotification('Only PDF files are supported.', 'error'); return; }
      pdfs.forEach(processPDF);
    }

    function processPDF(file) {
      const id = 'pdf_' + Date.now() + Math.random().toString(36).slice(2,6);
      showUploadProgress(id, file.name);

      const reader = new FileReader();
      reader.onload = e => {
        const b64 = e.target.result.split(',')[1];
        const paper = { id, name: file.name, size: file.size, b64 };
        uploadedPapers.push(paper);
        updatePaperList();
        updateProgressStatus(id, 'done');
        updateContextBar();
        showNotification(`"${truncate(file.name, 30)}" added`, 'success');
        setTimeout(() => hideProgressItem(id), 1500);
      };
      reader.onerror = () => {
        showNotification(`Failed to read ${file.name}`, 'error');
        hideProgressItem(id);
      };
      reader.readAsDataURL(file);
    }

    function showUploadProgress(id, name) {
      const wrap = document.getElementById('uploadProgress');
      wrap.classList.add('visible');
      const item = document.createElement('div');
      item.className = 'progress-item';
      item.id = 'prog_' + id;
      item.innerHTML = `
        <span class="progress-name">${escHtml(name)}</span>
        <div class="progress-bar-wrap"><div class="progress-bar" style="width:80%"></div></div>
        <span class="progress-status">reading…</span>
      `;
      wrap.appendChild(item);
    }

    function updateProgressStatus(id, status) {
      const item = document.getElementById('prog_' + id);
      if (!item) return;
      item.querySelector('.progress-bar').style.width = '100%';
      item.querySelector('.progress-status').textContent = status === 'done' ? '✓' : status;
    }

    function hideProgressItem(id) {
      const item = document.getElementById('prog_' + id);
      if (item) item.remove();
      const wrap = document.getElementById('uploadProgress');
      if (!wrap.children.length) wrap.classList.remove('visible');
    }

    function updatePaperList() {
      const list = document.getElementById('paperList');
      const noPapers = document.getElementById('noPapers');
      const count = document.getElementById('paperCount');

      count.textContent = uploadedPapers.length;

      if (!uploadedPapers.length) {
        noPapers.style.display = 'block';
        // remove all paper items
        list.querySelectorAll('.paper-item').forEach(el => el.remove());
        return;
      }

      noPapers.style.display = 'none';

      // rebuild list
      list.querySelectorAll('.paper-item').forEach(el => el.remove());
      uploadedPapers.forEach((p, i) => {
        const item = document.createElement('div');
        item.className = 'paper-item';
        item.id = 'paper_' + p.id;
        item.innerHTML = `
          <div class="paper-icon">PDF</div>
          <div class="paper-info">
            <div class="paper-name" title="${escHtml(p.name)}">${escHtml(truncate(p.name.replace('.pdf',''), 28))}</div>
            <div class="paper-meta">${formatBytes(p.size)}</div>
          </div>
          <button class="paper-remove" onclick="removePaper('${p.id}', event)" title="Remove">×</button>
        `;
        list.appendChild(item);
      });
    }

    function removePaper(id, event) {
      event.stopPropagation();
      uploadedPapers = uploadedPapers.filter(p => p.id !== id);
      updatePaperList();
      updateContextBar();
    }

    // ─── SOURCE TOGGLE ───
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeSource = btn.dataset.source;
        updateContextBar();
      });
    });

    function updateContextBar() {
      const bar = document.getElementById('contextBar');
      const none = document.getElementById('contextNone');
      bar.querySelectorAll('.context-tag').forEach(el => el.remove());

      const tags = [];

      if ((activeSource === 'uploads' || activeSource === 'both') && uploadedPapers.length > 0) {
        tags.push(`${uploadedPapers.length} PDF${uploadedPapers.length>1?'s':''}`);
      }
      if (activeSource === 's3' || activeSource === 'both') {
        tags.push('S3 Bucket');
      }

      if (!tags.length) {
        none.style.display = '';
        return;
      }

      none.style.display = 'none';
      tags.forEach(t => {
        const tag = document.createElement('div');
        tag.className = 'context-tag';
        tag.innerHTML = `<span class="context-tag-dot"></span>${t}`;
        bar.insertBefore(tag, none);
      });
    }

    // ─── CHAT ───
    async function sendQuestion() {
      if (isLoading) return;
      const input = document.getElementById('questionInput');
      const question = input.value.trim();
      if (!question) return;

      // Validation
      if (activeSource === 'uploads' && !uploadedPapers.length) {
        showNotification('Upload at least one PDF first, or switch context source to S3.', 'error');
        return;
      }

      showMessages();
      appendUserMessage(question);
      input.value = '';
      resizeTextarea(input);
      updateCharCount('');

      isLoading = true;
      document.getElementById('sendBtn').disabled = true;
      showTypingIndicator();

      try {
        const payload = { question };

        // Attach PDFs if needed
        if ((activeSource === 'uploads' || activeSource === 'both') && uploadedPapers.length) {
          payload.pdf_files = uploadedPapers.map(p => ({ name: p.name, data: p.b64 }));
        }

        if (activeSource === 's3' || activeSource === 'both') {
          payload.use_s3 = true;
        }

        const r = await fetch(`${API_BASE}/response`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await r.json();
        hideTypingIndicator();

        if (!r.ok || data.error) {
          appendAssistantMessage(`Error: ${data.error || 'Something went wrong. Is the backend running?'}`);
        } else {
          appendAssistantMessage(data.response);
        }
      } catch (err) {
        hideTypingIndicator();
        appendAssistantMessage(`Could not reach the server. Make sure your backend is running at \`${API_BASE}\` Message: ${err.message}`);
        console.log(err);
      }

      isLoading = false;
      document.getElementById('sendBtn').disabled = false;
    }

    function showMessages() {
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('messages').style.display = 'flex';
    }

    function appendUserMessage(text) {
      msgCount++;
      const container = document.getElementById('messages');

      if (msgCount > 1) {
        const divider = document.createElement('div');
        divider.className = 'msg-divider';
        divider.innerHTML = `<span class="msg-divider-text">Query ${msgCount}</span>`;
        container.appendChild(divider);
      }

      const msg = document.createElement('div');
      msg.className = 'msg-group';
      msg.innerHTML = `
        <div class="msg-user">
          <div class="msg-user-label">Your question</div>
          <div class="msg-user-text">${escHtml(text)}</div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
          <div class="msg-assistant-header">
            <div class="msg-assistant-icon"><svg viewBox="0 0 14 14"><path d="M7 1l1.5 4H13l-3.5 2.5L11 12 7 9.5 3 12l1.5-4.5L1 5h4.5z"/></svg></div>
            <span class="msg-assistant-label">Folio</span>
          </div>
          <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
      `;
      container.appendChild(msg);
      scrollBottom();
    }

    function appendAssistantMessage(text) {
      const typing = document.getElementById('typingIndicator');
      if (typing) typing.remove();

      const container = document.getElementById('messages');
      const lastGroup = container.querySelector('.msg-group:last-child');

      const response = document.createElement('div');
      response.className = 'msg-assistant';
      response.innerHTML = `
        <div class="msg-assistant-header">
          <div class="msg-assistant-icon"><svg viewBox="0 0 14 14"><path d="M7 1l1.5 4H13l-3.5 2.5L11 12 7 9.5 3 12l1.5-4.5L1 5h4.5z"/></svg></div>
          <span class="msg-assistant-label">Folio</span>
        </div>
        <div class="msg-assistant-body">${formatMarkdown(text)}</div>
      `;

      if (lastGroup) lastGroup.appendChild(response);
      else container.appendChild(response);
      scrollBottom();
    }

    function showTypingIndicator() {
      const el = document.getElementById('typingIndicator');
      if (el) el.classList.add('visible');
      scrollBottom();
    }

    function hideTypingIndicator() {
      const el = document.getElementById('typingIndicator');
      if (el) el.classList.remove('visible');
    }

    function scrollBottom() {
      const area = document.getElementById('chatArea');
      setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);
    }

    // ─── SUGGESTION CHIPS ───
    function useChip(el) {
      const input = document.getElementById('questionInput');
      input.value = el.textContent.trim();
      input.focus();
      resizeTextarea(input);
      updateCharCount(input.value);
    }

    // ─── TEXTAREA ───
    function autoResizeTextarea() {
      const ta = document.getElementById('questionInput');
      ta.addEventListener('input', () => {
        resizeTextarea(ta);
        updateCharCount(ta.value);
      });
      ta.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendQuestion();
        }
      });
    }

    function resizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 180) + 'px';
    }

    function updateCharCount(val) {
      document.getElementById('charCount').textContent = val.length;
    }

    // ─── HELPERS ───
    function showNotification(msg, type = '') {
      const el = document.getElementById('notification');
      el.textContent = msg;
      el.className = `notification ${type} show`;
      setTimeout(() => el.classList.remove('show'), 3000);
    }

    function escHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function truncate(str, len) {
      return str.length > len ? str.slice(0, len) + '…' : str;
    }

    function formatBytes(b) {
      if (b < 1024) return b + ' B';
      if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
      return (b/1048576).toFixed(1) + ' MB';
    }

    function formatMarkdown(text) {
      // Basic markdown → HTML
      return text
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\n{2,}/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/^/, '<p>').replace(/$/, '</p>')
        .replace(/<p><\/p>/g, '');
    }
  </script>
</body>
</html>